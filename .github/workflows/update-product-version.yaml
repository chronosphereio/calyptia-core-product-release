name: Update specific product version
on:
    workflow_call:
        inputs:
            product:
                description: The JSON key(s) for the product(s) to update. Comma separated if more than one.
                required: true
                type: string
            version:
                description: The numeric (no v- prefix) version(s) to update to. Comma separated if more than one and matching index in the product array.
                required: true
                type: string
        secrets:
            token:
                required: true
                description: The Github token to use for check out.
        outputs:
            pr:
                value: ${{ jobs.version-update.outputs.pr || '' }}
                description: The PR created, if any, or an empty string.
jobs:
    version-update:
        name: Update versions
        runs-on: ubuntu-latest
        outputs:
            pr: ${{ steps.cpr.outputs.pull-request-number || '' }}
        steps:
            - name: Add dependencies
              run: |
                sudo apt-get update
                sudo apt-get install -y jq
              shell: bash

            - uses: actions/checkout@v4
              with:
                token: ${{ secrets.token }}
                repository: calyptia/core-product-release

            - name: Sanitise product names
              id: sanitise
              run: |
                BRANCH=${PRODUCT//,/_}
                echo "branch=$BRANCH"
                echo "branch=$BRANCH" >> GITHUB_OUTPUT
              shell: bash
              env:
                PRODUCT: ${{ inputs.product }}

            - name: Update versions
              run: ./scripts/update-versions.sh
              shell: bash
              env:
                PRODUCTS: ${{ inputs.product }}
                VERSIONS: ${{ inputs.version }}

            - name: Generate PR - runs all the tests
              id: cpr
              uses: peter-evans/create-pull-request@v5
              with:
                commit-message: 'ci: update to latest versions'
                signoff: true
                # Repeated calls will sit on top of each other to test as one until merged
                # Only updates per product
                branch: ci_update_versions_push_${{ steps.sanitise.outputs.branch }}
                delete-branch: true
                title: 'ci: update to latest Calyptia versions'
                # We need workflows permission so have to use the CI_PAT
                token: ${{ secrets.token }}
                labels: ci,automerge
                body: |
                  Update Calyptia versions
                  - ${{ inputs.product }} = "${{ inputs.version }}"

                  Github info:
                  - Created by ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
                  - Auto-generated by create-pull-request: https://github.com/peter-evans/create-pull-request
                draft: false

            - name: Check outputs
              if: ${{ steps.cpr.outputs.pull-request-number }}
              run: |
                echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
                echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"
              shell: bash

            - name: Enable Pull Request Automerge
              if: ${{ steps.cpr.outputs.pull-request-number }}
              run: gh pr merge --squash --auto "${{ steps.cpr.outputs.pull-request-number }}"
              env:
                GH_TOKEN: ${{ secrets.token }}
