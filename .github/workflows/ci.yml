---
name: CI - test (and release)
on:
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci-get-metadata:
    uses: ./.github/workflows/get-versions.yaml

  ci-e2e-tests:
    needs:
      - ci-get-metadata
    # We cannot run this from a public repo as the cloud-e2e repo is private so even though it shares workflows with the Calyptia org,
    # they can only be run from a private calling repo.
    # uses: calyptia/cloud-e2e/.github/workflows/call-integration-tests.yaml@main
    # Instead we have to replicate the same workflow locally
    uses: ./.github/workflows/call-integration-tests.yaml
    strategy:
      fail-fast: false
      matrix:
        testset:
          - operator-install
          - operator
    with:
      cli-version: v${{ needs.ci-get-metadata.outputs.cli-version }}
      cloud-image: ghcr.io/calyptia/cloud:${{ needs.ci-get-metadata.outputs.cloud-version }}
      core-image: ghcr.io/calyptia/core:${{ needs.ci-get-metadata.outputs.core-version }}
      core-operator-image: ghcr.io/calyptia/core-operator:${{ needs.ci-get-metadata.outputs.core-operator-version }}
      core-operator-from-cloud-image: ghcr.io/calyptia/core-operator/sync-from-cloud:${{ needs.ci-get-metadata.outputs.core-operator-version }}
      core-operator-to-cloud-image: ghcr.io/calyptia/core-operator/sync-to-cloud:${{ needs.ci-get-metadata.outputs.core-operator-version }}
      calyptia-tests: "${{ matrix.testset }}/"
    secrets:
      registry-username: ${{ secrets.CI_USERNAME }}
      registry-password: ${{ secrets.CI_PAT }}
      # Replace with playground key after: https://app.asana.com/0/1205042382663691/1205231066738712/f
      google-access-key: ${{ secrets.GCP_SA_KEY }}
      github-token: ${{ secrets.CI_PAT }}

  ci-e2e-tests-openshift:
    needs:
      - ci-get-metadata
    # We cannot run this from a public repo as the cloud-e2e repo is private so even though it shares workflows with the Calyptia org,
    # they can only be run from a private calling repo.
    # uses: calyptia/cloud-e2e/.github/workflows/call-integration-tests.yaml@main
    # Instead we have to replicate the same workflow locally
    uses: ./.github/workflows/call-integration-tests.yaml
    strategy:
      fail-fast: false
      matrix:
        testset:
          - operator-install
          - operator
    with:
      cli-version: v${{ needs.ci-get-metadata.outputs.cli-version }}
      cloud-image: ghcr.io/calyptia/cloud:${{ needs.ci-get-metadata.outputs.cloud-version }}
      core-image: ghcr.io/calyptia/core:${{ needs.ci-get-metadata.outputs.core-version }}
      core-operator-image: ghcr.io/calyptia/core-operator:${{ needs.ci-get-metadata.outputs.core-operator-version }}
      core-operator-from-cloud-image: ghcr.io/calyptia/core-operator/sync-from-cloud:${{ needs.ci-get-metadata.outputs.core-operator-version }}
      core-operator-to-cloud-image: ghcr.io/calyptia/core-operator/sync-to-cloud:${{ needs.ci-get-metadata.outputs.core-operator-version }}
      calyptia-tests: "${{ matrix.testset }}/"
      k8s-distribution: openshift
    secrets:
      registry-username: ${{ secrets.CI_USERNAME }}
      registry-password: ${{ secrets.CI_PAT }}
      # Replace with playground key after: https://app.asana.com/0/1205042382663691/1205231066738712/f
      google-access-key: ${{ secrets.GCP_SA_KEY }}
      github-token: ${{ secrets.CI_PAT }}
